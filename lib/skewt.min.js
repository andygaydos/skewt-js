/*
 * SkewT v1.1.0
 * 2016 David Felix - dfelix@live.com.pt
 * Dependency:
 * d3.v3.min.js from https://d3js.org/
 */
var SkewT=function(a){function E(){c=parseInt(b.style("width"),10)-10,d=c,p=c-e.left-e.right,q=c-e.top-e.bottom,r=d3.scale.linear().range([0,p]).domain([-45,50]),s=d3.scale.log().range([0,q]).domain([i,h]),t=d3.svg.axis().scale(r).tickSize(0,0).ticks(10).orient("bottom"),u=d3.svg.axis().scale(s).tickSize(0,0).tickValues(j).tickFormat(d3.format(".0d")).orient("left"),v=d3.svg.axis().scale(s).tickSize(5,0).tickValues(k).orient("right")}function F(){B.selectAll("*").remove(),E(),z.attr("width",p+e.right+e.left).attr("height",q+e.top+e.bottom),A.attr("transform","translate("+e.left+","+e.top+")"),G(),J(w)}var p,q,r,s,t,u,v,b=d3.select(a),c=parseInt(b.style("width"),10),d=c,e={top:30,right:40,bottom:20,left:35},f=Math.PI/180,g=Math.tan(55*f),h=1050,i=100,j=[1e3,850,700,500,300,200,100],k=[950,900,800,750,650,600,550,450,400,350,250,150],o=(d3.scale.linear().range([0,300]).domain([0,150]),d3.scale.linear(),d3.bisector(function(a){return a.press}).left),w=[],x=function(a){return 1.943844492*a},y=function(a){return 3.6*a},z=b.append("svg").attr("id","svg"),A=z.append("g").attr("id","container"),B=A.append("g").attr("id","skewtbg").attr("class","skewtbg"),C=A.append("g").attr("class","skewt"),D=A.append("g").attr("class","windbarb");d3.select(window).on("resize",F);var G=function(){B.append("clipPath").attr("id","clipper").append("rect").attr("x",0).attr("y",0).attr("width",p).attr("height",q),B.selectAll("templine").data(d3.range(-100,45,10)).enter().append("line").attr("x1",function(a){return r(a)-.5+(s(h)-s(100))/g}).attr("x2",function(a){return r(a)-.5}).attr("y1",0).attr("y2",q).attr("class",function(a){return 0==a?"tempzero":"gridline"}).attr("clip-path","url(#clipper)"),B.selectAll("pressureline").data(j).enter().append("line").attr("x1",0).attr("x2",p).attr("y1",function(a){return s(a)}).attr("y2",function(a){return s(a)}).attr("class","gridline");for(var a=d3.range(i,h+1,10),b=d3.range(-30,240,20),c=[],d=0;d<b.length;d++){for(var e=[],f=0;f<a.length;f++)e.push(b[d]);c.push(e)}var k=d3.svg.line().interpolate("linear").x(function(b,c){return r((273.15+b)/Math.pow(1e3/a[c],.286)-273.15)+(s(h)-s(a[c]))/g}).y(function(b,c){return s(a[c])});B.selectAll("dryadiabatline").data(c).enter().append("path").attr("class","gridline").attr("clip-path","url(#clipper)").attr("d",k),B.append("line").attr("x1",p-.5).attr("x2",p-.5).attr("y1",0).attr("y2",q).attr("class","gridline"),B.append("g").attr("class","x axis").attr("transform","translate(0,"+(q-.5)+")").call(t),B.append("g").attr("class","y axis").attr("transform","translate(-0.5,0)").call(u),B.append("g").attr("class","y axis ticks").attr("transform","translate(-0.5,0)").call(v)},I=function(a){var b=a.reverse(),c=C.append("g").attr("class","focus tmpc").style("display","none");c.append("circle").attr("r",4),c.append("text").attr("x",9).attr("dy",".35em");var d=C.append("g").attr("class","focus dwpc").style("display","none");d.append("circle").attr("r",4),d.append("text").attr("x",-9).attr("text-anchor","end").attr("dy",".35em");var e=C.append("g").attr("class","focus").style("display","none");e.append("text").attr("x",0).attr("text-anchor","start").attr("dy",".35em");var f=C.append("g").attr("class","focus windspeed").style("display","none");f.append("text").attr("x",0).attr("text-anchor","start").attr("dy",".35em"),A.append("rect").attr("class","overlay").attr("width",p).attr("height",q).on("mouseover",function(){c.style("display",null),d.style("display",null),e.style("display",null),f.style("display",null)}).on("mouseout",function(){c.style("display","none"),d.style("display","none"),e.style("display","none"),f.style("display","none")}).on("mousemove",function(){var a=s.invert(d3.mouse(this)[1]),i=o(b,a,1,b.length-1),j=b[i-1],k=b[i],l=a-j.press>k.press-a?k:j;c.attr("transform","translate("+(r(l.temp)+(s(h)-s(l.press))/g)+","+s(l.press)+")"),d.attr("transform","translate("+(r(l.dwpt)+(s(h)-s(l.press))/g)+","+s(l.press)+")"),e.attr("transform","translate(0,"+s(l.press)+")"),c.select("text").text(Math.round(l.temp)+"°C"),d.select("text").text(Math.round(l.dwpt)+"°C"),e.select("text").text("-- "+Math.round(l.hght)+" m"),f.attr("transform","translate(555,"+s(l.press)+")"),f.select("text").text(Math.round(10*x(l.wspd))/10+" kts")})},J=function(a){if(w=a,C.selectAll("path").remove(),0!=w.length){var b=w.filter(function(a){return a.temp>-1e3&&a.dwpt>-1e3}),c=[];c.push(b);var d=d3.svg.line().interpolate("linear").x(function(a,b){return r(a.temp)+(s(h)-s(a.press))/g}).y(function(a,b){return s(a.press)}),f=(C.selectAll("templines").data(c).enter().append("path").attr("class",function(a,b){return b<10?"temp skline":"temp mean"}).attr("clip-path","url(#clipper)").attr("d",d),d3.svg.line().interpolate("linear").x(function(a,b){return r(a.dwpt)+(s(h)-s(a.press))/g}).y(function(a,b){return s(a.press)}));C.selectAll("tempdewlines").data(c).enter().append("path").attr("class",function(a,b){return b<10?"dwpt skline":"dwpt mean"}).attr("clip-path","url(#clipper)").attr("d",f);D.selectAll("use").remove();var k=b.filter(function(a){return a.wdir>=0&&a.wspd>=0&&a.press>=i});D.selectAll("barbs").data(k).enter().append("use").attr("xlink:href",function(a){return"#barb"+5*Math.round(y(a.wspd)/5)}).attr("transform",function(a,b){return"translate("+p+","+s(a.press)+") rotate("+(a.wdir+180)+")"});I(c[0])}},K=function(a){C.selectAll("path").remove(),D.selectAll("use").remove(),A.append("rect").attr("class","overlay").attr("width",p).attr("height",q).on("mouseover",function(){return!1}).on("mouseout",function(){return!1}).on("mousemove",function(){return!1})};this.drawBackground=G,this.plot=J,this.clear=K,E(),F()};